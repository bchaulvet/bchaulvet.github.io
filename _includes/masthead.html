{% include base_path %}
{% assign current_lang = page.lang | default: site.lang_default | default: 'en' %}
{% assign navdata = site.data.navigation.main | default: empty %}
{% if navdata == empty %}{% assign navdata = "" | split:"|" %}{% endif %}

{%- comment -%} Aggregate all docs (pages + collections) for counterpart lookup {%- endcomment -%}
{% assign all_docs = site.pages %}
{% for coll in site.collections %}
  {% assign all_docs = all_docs | concat: coll.docs %}
{% endfor %}

{%- comment -%}
Button shows the OTHER language (target). If you want current language instead, swap assignments for lang_label only.
{%- endcomment -%}
{% if current_lang == 'en' %}
  {% assign target_lang = 'fr' %}
  {% assign lang_label = 'FR' %}
  {% assign fallback_url = '/fr/' %}
{% else %}
  {% assign target_lang = 'en' %}
  {% assign lang_label = 'EN' %}
  {% assign fallback_url = '/' %}
{% endif %}

{%- assign lang_url = fallback_url -%}
{%- if page.ref -%}
  {% assign counterpart = all_docs | where:'ref',page.ref | where:'lang',target_lang | first %}
  {% if counterpart and counterpart.url %}{% assign lang_url = counterpart.url %}{% endif %}
{%- endif -%}

<div class="masthead" data-lang="{{ current_lang }}" data-target="{{ target_lang }}">
  <div class="masthead__inner-wrap">
    <nav id="site-nav" class="greedy-nav">
      <a class="site-title" href="{% if current_lang == 'fr' %}{{ '/fr/' | relative_url }}{% else %}{{ '/' | relative_url }}{% endif %}">{{ site.title }}</a>
      <ul class="visible-links">
        {% for item in navdata %}
          {% assign item_title = item.title[current_lang] | default: item.title.en | default: item.title.fr %}
          {% assign item_url   = item.url[current_lang]   | default: item.url.en   | default: item.url.fr %}
          <li class="masthead__menu-item"><a href="{{ item_url | relative_url }}">{{ item_title }}</a></li>
        {% endfor %}
      </ul>
      <a id="lang-toggle" class="lang-link target-{{ target_lang }}" href="{{ lang_url | relative_url }}"
         aria-label="Switch language to {% if target_lang == 'fr' %}French{% else %}English{% endif %}">
        <span class="flag-icon" aria-hidden="true">
          {% if target_lang == 'fr' %}
            {% include flag-fr.svg %}
          {% else %}
            {% include flag-en.svg %}
          {% endif %}
        </span>
        <span class="visually-hidden">{{ lang_label }}</span>
      </a>
      <button class="greedy-nav__toggle hidden" type="button" aria-label="Menu"><div class="navicon"></div></button>
      <ul class="hidden-links hidden"></ul>
    </nav>
  </div>
</div>